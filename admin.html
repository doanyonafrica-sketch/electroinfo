<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration | ElectroInfo</title>
    <meta name="description" content="Panneau d'administration - ElectroInfo">
    
    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
    <link rel="icon" type="image/png" sizes="48x48" href="/images/logo-small.png">
    
    <!-- Styles -->
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="/admin-styles.css">
    <link rel="stylesheet" href="/admin-improvements.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <!-- CodeMirror pour mode HTML -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">
    <style>
        /* ‚îÄ‚îÄ S√©lecteur de mode √©diteur ‚îÄ‚îÄ */
        .editor-mode-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            background: #f1f5f9;
            padding: 0.4rem;
            border-radius: 10px;
            width: fit-content;
        }
        .mode-btn {
            padding: 0.45rem 1.1rem;
            border: none;
            border-radius: 7px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.2s;
            color: #64748b;
            background: transparent;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }
        .mode-btn.active {
            background: white;
            color: #7c3aed;
            box-shadow: 0 2px 6px rgba(0,0,0,0.12);
        }
        .mode-btn:hover:not(.active) {
            background: #e2e8f0;
            color: #374151;
        }
        /* ‚îÄ‚îÄ √âditeur HTML (CodeMirror) dans admin articles ‚îÄ‚îÄ */
        #htmlEditorSection .editor-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #282a36;
            padding: 0.5rem 0.75rem;
            border-radius: 8px 8px 0 0;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        #htmlEditorSection .editor-label {
            color: #f8f8f2;
            font-weight: 600;
            font-size: 0.9rem;
        }
        #htmlEditorSection .editor-actions {
            display: flex;
            gap: 0.35rem;
            flex-wrap: wrap;
        }
        #htmlEditorSection .editor-btn {
            background: #44475a;
            color: #f8f8f2;
            border: none;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.78rem;
            font-weight: 600;
            transition: background 0.2s;
        }
        #htmlEditorSection .editor-btn:hover { background: #6272a4; }
        #htmlEditorSection .editor-btn.btn-preview { background: #50fa7b; color: #282a36; }
        #htmlEditorSection .editor-btn.btn-preview:hover { background: #69ff94; }
        #htmlEditorSection .editor-btn.btn-format { background: #bd93f9; color: #282a36; }
        #htmlEditorSection .editor-btn.btn-format:hover { background: #caa9fa; }
        #htmlEditorSection .editor-container {
            border: 2px solid #282a36;
            border-top: none;
        }
        #htmlEditorSection .CodeMirror {
            height: 350px;
            font-size: 0.9rem;
            font-family: 'Fira Code', 'Consolas', monospace;
        }
        #htmlEditorSection .editor-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.4rem 0.75rem;
            background: #1e1f29;
            border-radius: 0 0 8px 8px;
            font-size: 0.8rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        #htmlEditorSection .char-count { color: #6272a4; }
        #htmlEditorSection .editor-hint { color: #6272a4; font-style: italic; }
        .article-html-preview {
            margin-top: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }
        .article-html-preview.hidden { display: none; }
        .article-html-preview .preview-header {
            background: #f9fafb;
            padding: 0.6rem 1rem;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.9rem;
        }
        .article-html-preview .preview-body {
            padding: 1.5rem;
            background: white;
            min-height: 100px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar admin-navbar">
        <div class="container">
            <div class="nav-brand">
                <i class="fas fa-user-shield"></i>
                <span>ADMIN - ELECTROINFO</span>
            </div>
            <div class="nav-actions">
                <a href="/index.html" class="btn btn-outline">
                    <i class="fas fa-home"></i> Accueil
                </a>

                  <a href="/admin-courses.html" class="btn btn-outline">
                    <i class="fas fa-home"></i> Cours panelle
                </a>
                   
                  <a href="PATCH_admin_newsletter.html" class="btn-redirect">
                       newsletter info
                  </a>

                <button id="logoutBtn" class="btn btn-danger">
                    <i class="fas fa-sign-out-alt"></i> D√©connexion
                </button>
            </div>
        </div>
    </nav>

    <!-- Loading -->
    <div id="loadingSection" class="loading-section">
        <div class="loading-content">
            <i class="fas fa-spinner fa-spin loading-icon"></i>
            <p>V√©rification des acc√®s...</p>
        </div>
    </div>

    <!-- Acc√®s refus√© -->
    <div id="accessDenied" class="access-denied hidden">
        <div class="access-denied-content">
            <i class="fas fa-ban error-icon"></i>
            <h2>Acc√®s Refus√©</h2>
            <p>Vous n'avez pas les droits administrateur.</p>
            <a href="/index.html" class="btn btn-primary">
                <i class="fas fa-home"></i> Retour √† l'accueil
            </a>
        </div>
    </div>

    <!-- Dashboard Admin -->
    <main id="adminDashboard" class="admin-dashboard hidden">
        <div class="container">
            <!-- Header -->
            <div class="admin-header">
                <h1><i class="fas fa-tachometer-alt"></i> Tableau de bord</h1>
                <div class="user-info">
                    <img id="adminAvatar" src="" alt="Avatar" class="avatar">
                    <span id="adminName"></span>
                </div>
            </div>

            <!-- Statistiques -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon blue">
                        <i class="fas fa-newspaper"></i>
                    </div>
                    <div class="stat-content">
                        <p class="stat-label">Total Articles</p>
                        <p class="stat-value" id="totalArticles">0</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon green">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-content">
                        <p class="stat-label">Publi√©s</p>
                        <p class="stat-value" id="publishedArticles">0</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon yellow">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-content">
                        <p class="stat-label">Programm√©s</p>
                        <p class="stat-value" id="scheduledArticles">0</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon purple">
                        <i class="fas fa-file-alt"></i>
                    </div>
                    <div class="stat-content">
                        <p class="stat-label">Brouillons</p>
                        <p class="stat-value" id="draftArticles">0</p>
                    </div>
                </div>
            </div>

            <!-- Formulaire Article -->
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-plus-circle"></i> <span id="formTitle">Nouvel Article</span></h2>
                </div>
                <div class="card-body">
                    <form id="articleForm">
                        <input type="hidden" id="editArticleId">

                        <div class="form-row">
                            <div class="form-group">
                                <label>Titre *</label>
                                <input type="text" id="title" required class="input" placeholder="Ex: La r√©volution des batteries solides">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Cat√©gorie *</label>
                                <select id="category" class="input">
                                    <option>INNOVATION</option>
                                    <option>S√âCURIT√â</option>
                                    <option>NOUVEAUT√â</option>
                                    <option>TUTO</option>
                                    <option>DOMOTIQUE</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="checkbox">
                                    <input type="checkbox" id="featured">
                                    <span>Article en vedette</span>
                                </label>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>URL de l'image</label>
                                <input type="url" id="imageUrl" class="input" placeholder="https://example.com/image.jpg">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>R√©sum√© *</label>
                                <textarea id="summary" required rows="3" class="input" placeholder="Un court r√©sum√© de l'article..."></textarea>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Contenu *</label>

                                <!-- S√©lecteur de mode -->
                                <div class="editor-mode-selector">
                                    <button type="button" class="mode-btn active" id="modeQuillBtn" onclick="switchArticleEditorMode('quill')">
                                        <i class="fas fa-align-left"></i> √âditeur Visuel
                                    </button>
                                    <button type="button" class="mode-btn" id="modeHtmlBtn" onclick="switchArticleEditorMode('html')">
                                        <i class="fas fa-code"></i> HTML Avanc√©
                                    </button>
                                </div>

                                <!-- MODE QUILL (par d√©faut) -->
                                <div id="quillEditorSection">
                                    <div id="editor" style="min-height: 300px; background: white;"></div>
                                </div>

                                <!-- MODE HTML CODEMIRROR -->
                                <div id="htmlEditorSection" style="display:none;">
                                    <div class="editor-toolbar">
                                        <span class="editor-label"><i class="fas fa-code"></i> Contenu HTML de l'article</span>
                                        <div class="editor-actions">
                                            <button type="button" class="editor-btn" onclick="articleInsertSnippet('heading')" title="Titre h2">H2</button>
                                            <button type="button" class="editor-btn" onclick="articleInsertSnippet('paragraph')" title="Paragraphe"><i class="fas fa-paragraph"></i></button>
                                            <button type="button" class="editor-btn" onclick="articleInsertSnippet('table')" title="Tableau"><i class="fas fa-table"></i></button>
                                            <button type="button" class="editor-btn" onclick="articleInsertSnippet('image')" title="Image"><i class="fas fa-image"></i></button>
                                            <button type="button" class="editor-btn" onclick="articleInsertSnippet('list')" title="Liste"><i class="fas fa-list"></i></button>
                                            <button type="button" class="editor-btn" onclick="articleInsertSnippet('alert')" title="Alerte"><i class="fas fa-exclamation-circle"></i></button>
                                            <button type="button" class="editor-btn" onclick="articleInsertSnippet('grid')" title="Grille"><i class="fas fa-th"></i></button>
                                            <button type="button" class="editor-btn btn-format" onclick="articleFormatCode()" title="Formater"><i class="fas fa-magic"></i></button>
                                            <button type="button" class="editor-btn btn-preview" onclick="articleTogglePreview()" title="Aper√ßu"><i class="fas fa-eye"></i> Aper√ßu</button>
                                        </div>
                                    </div>
                                    <div class="editor-container">
                                        <div id="articleCmEditor" class="codemirror-wrapper"></div>
                                    </div>
                                    <div id="articleHtmlPreview" class="article-html-preview hidden">
                                        <div class="preview-header"><i class="fas fa-eye"></i> Aper√ßu du rendu</div>
                                        <div class="preview-body"></div>
                                    </div>
                                    <div class="editor-footer">
                                        <span class="char-count" id="articleCmCount">0 caract√®res</span>
                                        <span class="editor-hint">üí° HTML complet ‚Äî tables, flex, grid, images, styles inline support√©s</span>
                                    </div>
                                </div>

                                <textarea id="content" style="display: none;"></textarea>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Tags (s√©par√©s par des virgules)</label>
                                <input type="text" id="tags" class="input" placeholder="Ex: √©lectricit√©, innovation, IoT">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Statut de publication</label>
                                <select id="publicationStatus" class="input" onchange="toggleScheduleFields()">
                                    <option value="published">Publier imm√©diatement</option>
                                    <option value="draft">Enregistrer comme brouillon</option>
                                    <option value="scheduled">Programmer la publication</option>
                                </select>
                            </div>
                        </div>

                        <div id="scheduleFields" class="form-row" style="display: none;">
                            <div class="form-group">
                                <label>Date de publication</label>
                                <input type="date" id="scheduleDate" class="input">
                            </div>
                            <div class="form-group">
                                <label>Heure de publication</label>
                                <input type="time" id="scheduleTime" class="input">
                            </div>
                        </div>

                        <div id="scheduleInfo" class="alert alert-info" style="display: none; margin-top: 1rem;">
                            <i class="fas fa-info-circle"></i>
                            <div>
                                <strong>Publication programm√©e</strong>
                                <p id="schedulePreview" style="margin: 0.5rem 0 0 0;"></p>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane"></i> <span id="submitBtnText">Publier</span>
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="cancelEdit()">
                                <i class="fas fa-redo"></i> Annuler
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Barre de recherche -->
            <div class="search-articles-section">
                <div class="search-bar-admin">
                    <i class="fas fa-search"></i>
                    <input 
                        type="text" 
                        id="adminSearchInput" 
                        placeholder="Rechercher un article par titre, cat√©gorie ou tag..."
                        class="search-input-admin"
                    >
                    <button id="clearSearch" class="btn-clear-search hidden" onclick="clearAdminSearch()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="searchResultsCount" class="search-results-count hidden"></div>
            </div>

            <!-- Articles Publi√©s -->
            <div class="card accordion-card">
                <div class="card-header accordion-header" onclick="toggleAccordion('published')">
                    <div class="accordion-title">
                        <i class="fas fa-chevron-down accordion-icon" id="publishedIcon"></i>
                        <h2><i class="fas fa-check-circle"></i> Articles Publi√©s</h2>
                        <span class="count-badge" id="publishedCount">0</span>
                    </div>
                </div>
                <div class="card-body accordion-body" id="publishedAccordion">
                    <div id="publishedArticlesList">
                        <div class="loading"><i class="fas fa-spinner fa-spin"></i><p>Chargement...</p></div>
                    </div>
                    <div id="publishedPagination" class="admin-pagination hidden"></div>
                </div>
            </div>

            <!-- Articles Programm√©s -->
            <div class="card accordion-card">
                <div class="card-header accordion-header" onclick="toggleAccordion('scheduled')">
                    <div class="accordion-title">
                        <i class="fas fa-chevron-down accordion-icon" id="scheduledIcon"></i>
                        <h2><i class="fas fa-clock"></i> Articles Programm√©s</h2>
                        <span class="count-badge" id="scheduledCount">0</span>
                    </div>
                </div>
                <div class="card-body accordion-body" id="scheduledAccordion">
                    <div id="scheduledArticlesList">
                        <div class="empty-state">
                            <i class="fas fa-clock"></i>
                            <p>Aucun article programm√©</p>
                        </div>
                    </div>
                    <div id="scheduledPagination" class="admin-pagination hidden"></div>
                </div>
            </div>

            <!-- Brouillons -->
            <div class="card accordion-card">
                <div class="card-header accordion-header" onclick="toggleAccordion('drafts')">
                    <div class="accordion-title">
                        <i class="fas fa-chevron-down accordion-icon" id="draftsIcon"></i>
                        <h2><i class="fas fa-file-alt"></i> Brouillons</h2>
                        <span class="count-badge" id="draftsCount">0</span>
                    </div>
                </div>
                <div class="card-body accordion-body" id="draftsAccordion">
                    <div id="draftsArticlesList">
                        <div class="empty-state">
                            <i class="fas fa-file-alt"></i>
                            <p>Aucun brouillon</p>
                        </div>
                    </div>
                    <div id="draftsPagination" class="admin-pagination hidden"></div>
                </div>
            </div>

            <!-- Newsletter -->
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-envelope"></i> Abonn√©s Newsletter</h2>
                </div>
                <div class="card-body">
                    <div class="newsletter-actions">
                        <button onclick="exportNewsletterCSV()" class="btn btn-primary">
                            <i class="fas fa-download"></i> Exporter CSV
                        </button>
                    </div>
                    <div id="newsletterList">
                        <div class="loading"><i class="fas fa-spinner fa-spin"></i><p>Chargement...</p></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Suppression -->
    <div id="deleteModal" class="modal hidden">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-exclamation-triangle"></i> Confirmer la suppression</h3>
            </div>
            <div class="modal-body">
                <p>√ätes-vous s√ªr de vouloir supprimer cet article ?</p>
                <p class="text-danger">Cette action est irr√©versible.</p>
            </div>
            <div class="modal-footer">
                <button id="cancelDelete" class="btn btn-secondary">Annuler</button>
                <button id="confirmDelete" class="btn btn-danger">
                    <i class="fas fa-trash"></i> Supprimer
                </button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification hidden"></div>

    <!-- Scripts -->
    <!-- CodeMirror JS pour mode HTML -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closetag.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldgutter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/xml-fold.min.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        // ============================================
        // S√âLECTEUR DE MODE √âDITEUR ARTICLE
        // ============================================
        let articleEditorMode = 'quill'; // 'quill' ou 'html'
        let articleCmInstance = null;

        window.switchArticleEditorMode = function(mode) {
            if (mode === articleEditorMode) return;
            articleEditorMode = mode;

            const quillSection = document.getElementById('quillEditorSection');
            const htmlSection = document.getElementById('htmlEditorSection');
            const modeQuillBtn = document.getElementById('modeQuillBtn');
            const modeHtmlBtn = document.getElementById('modeHtmlBtn');

            if (mode === 'html') {
                // R√©cup√©rer le contenu Quill actuel avant de basculer
                let currentContent = '';
                if (window._quillEditorRef) {
                    currentContent = window._quillEditorRef.root.innerHTML;
                    if (currentContent === '<p><br></p>') currentContent = '';
                }

                quillSection.style.display = 'none';
                htmlSection.style.display = 'block';
                modeQuillBtn.classList.remove('active');
                modeHtmlBtn.classList.add('active');

                // Initialiser CodeMirror si pas encore fait
                if (!articleCmInstance) {
                    const wrapper = document.getElementById('articleCmEditor');
                    const textarea = document.createElement('textarea');
                    textarea.id = 'articleCmTextarea';
                    wrapper.appendChild(textarea);
                    articleCmInstance = CodeMirror.fromTextArea(textarea, {
                        mode: 'htmlmixed',
                        theme: 'dracula',
                        lineNumbers: true,
                        lineWrapping: true,
                        autoCloseTags: true,
                        autoCloseBrackets: true,
                        matchTags: { bothTags: true },
                        extraKeys: { 'Ctrl-Space': 'autocomplete' },
                        tabSize: 2,
                        indentWithTabs: false
                    });
                    articleCmInstance.on('change', function(cm) {
                        document.getElementById('articleCmCount').textContent = cm.getValue().length + ' caract√®res';
                    });
                }
                articleCmInstance.setValue(currentContent);
                articleCmInstance.refresh();
                setTimeout(() => articleCmInstance.refresh(), 100);

            } else {
                // R√©cup√©rer le HTML de CodeMirror avant de basculer
                let htmlContent = articleCmInstance ? articleCmInstance.getValue() : '';

                quillSection.style.display = 'block';
                htmlSection.style.display = 'none';
                modeQuillBtn.classList.add('active');
                modeHtmlBtn.classList.remove('active');

                // Injecter dans Quill
                if (window._quillEditorRef && htmlContent) {
                    window._quillEditorRef.root.innerHTML = htmlContent;
                }
            }
        };

        window.articleInsertSnippet = function(type) {
            if (!articleCmInstance) return;
            const snippets = {
                heading: '<h2>Titre de section</h2>\n',
                paragraph: '<p>Votre texte ici...</p>\n',
                table: '<table style="width:100%; border-collapse:collapse;">\n  <thead>\n    <tr>\n      <th style="border:1px solid #ddd; padding:8px; background:#f2f2f2;">Colonne 1</th>\n      <th style="border:1px solid #ddd; padding:8px; background:#f2f2f2;">Colonne 2</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <td style="border:1px solid #ddd; padding:8px;">Valeur 1</td>\n      <td style="border:1px solid #ddd; padding:8px;">Valeur 2</td>\n    </tr>\n  </tbody>\n</table>\n',
                image: '<img src="URL_IMAGE" alt="Description" style="max-width:100%; border-radius:8px;">\n',
                list: '<ul>\n  <li>√âl√©ment 1</li>\n  <li>√âl√©ment 2</li>\n  <li>√âl√©ment 3</li>\n</ul>\n',
                alert: '<div style="background:#fef3c7; border-left:4px solid #f59e0b; padding:1rem; border-radius:4px; margin:1rem 0;">\n  <strong>‚ö†Ô∏è Important :</strong> Votre message ici.\n</div>\n',
                grid: '<div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">\n  <div style="background:#f8fafc; padding:1rem; border-radius:8px;">Colonne gauche</div>\n  <div style="background:#f8fafc; padding:1rem; border-radius:8px;">Colonne droite</div>\n</div>\n'
            };
            const cursor = articleCmInstance.getCursor();
            articleCmInstance.replaceRange(snippets[type] || '', cursor);
            articleCmInstance.focus();
        };

        window.articleFormatCode = function() {
            if (!articleCmInstance) return;
            let code = articleCmInstance.getValue();
            let indent = 0;
            const formatted = code
                .replace(/>\s*</g, '>\n<')
                .split('\n')
                .map(line => {
                    line = line.trim();
                    if (!line) return '';
                    if (line.match(/^<\//)) indent = Math.max(0, indent - 1);
                    const result = '  '.repeat(indent) + line;
                    if (line.match(/^<[^/!][^>]*[^/]>$/) && !line.match(/^<(br|hr|img|input|meta|link)/i)) indent++;
                    return result;
                })
                .filter(l => l !== '')
                .join('\n');
            articleCmInstance.setValue(formatted);
        };

        window.articleTogglePreview = function() {
            const preview = document.getElementById('articleHtmlPreview');
            if (preview.classList.contains('hidden')) {
                const html = articleCmInstance ? articleCmInstance.getValue() : '';
                preview.querySelector('.preview-body').innerHTML = html;
                preview.classList.remove('hidden');
            } else {
                preview.classList.add('hidden');
            }
        };

        // ============================================
        // Fonctions existantes
        // ============================================
        function toggleScheduleFields() {
            const status = document.getElementById('publicationStatus').value;
            const scheduleFields = document.getElementById('scheduleFields');
            const scheduleInfo = document.getElementById('scheduleInfo');
            const submitBtn = document.getElementById('submitBtnText');
            
            if (status === 'scheduled') {
                scheduleFields.style.display = 'flex';
                scheduleInfo.style.display = 'flex';
                submitBtn.textContent = 'Programmer';
                updateSchedulePreview();
            } else {
                scheduleFields.style.display = 'none';
                scheduleInfo.style.display = 'none';
                submitBtn.textContent = status === 'draft' ? 'Enregistrer brouillon' : 'Publier';
            }
        }
        
        function updateSchedulePreview() {
            const dateInput = document.getElementById('scheduleDate');
            const timeInput = document.getElementById('scheduleTime');
            const preview = document.getElementById('schedulePreview');
            
            if (dateInput.value && timeInput.value) {
                const date = new Date(dateInput.value + 'T' + timeInput.value);
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
                preview.textContent = 'L\'article sera publi√© le ' + date.toLocaleDateString('fr-FR', options);
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const dateInput = document.getElementById('scheduleDate');
            const timeInput = document.getElementById('scheduleTime');
            
            if (dateInput) {
                dateInput.addEventListener('change', updateSchedulePreview);
                dateInput.setAttribute('min', new Date().toISOString().split('T')[0]);
            }
            if (timeInput) timeInput.addEventListener('change', updateSchedulePreview);
        });
    </script>
    <script type="module" src="/admin.js"></script>
    <script type="module" src="/admin-enhancements.js"></script>
</body>
</html>